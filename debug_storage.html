<!DOCTYPE html>
<html>
<head>
    <title>Debug Extension Storage</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .section { margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 5px; }
        .storage-data { background: #fff; padding: 10px; border-radius: 3px; margin: 10px 0; font-family: monospace; white-space: pre-wrap; }
        .field-analysis { background: #e3f2fd; padding: 10px; margin: 5px 0; border-radius: 3px; }
        .error { background: #ffebee; color: #c62828; padding: 10px; border-radius: 3px; }
        .success { background: #e8f5e8; color: #2e7d32; padding: 10px; border-radius: 3px; }
        button { padding: 8px 16px; margin: 5px; background: #2196f3; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #1976d2; }
        .test-data { background: #fff3e0; padding: 10px; border-radius: 3px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>Debug Extension Storage</h1>
    
    <div class="section">
        <h2>Storage Inspector</h2>
        <button onclick="inspectStorage()">Inspect All Storage</button>
        <button onclick="testSpecificTicker()">Test OPAD Data</button>
        <button onclick="injectTestData()">Inject Test Data</button>
        <button onclick="clearAll()">Clear All</button>
        <div id="storage-output"></div>
    </div>

    <div class="section">
        <h2>Data Flow Test</h2>
        <button onclick="testDataFlow()">Test Data Flow</button>
        <div id="dataflow-output"></div>
    </div>

    <script>
        async function inspectStorage() {
            const output = document.getElementById('storage-output');
            try {
                // Get all storage data
                const allData = await chrome.storage.local.get(null);
                
                output.innerHTML = '<h3>All Storage Data:</h3>';
                
                if (Object.keys(allData).length === 0) {
                    output.innerHTML += '<div class="error">No data found in storage</div>';
                    return;
                }
                
                // Show ticker data specifically
                const tickerKeys = Object.keys(allData).filter(key => key.startsWith('ticker_'));
                
                if (tickerKeys.length === 0) {
                    output.innerHTML += '<div class="error">No ticker data found in storage</div>';
                    return;
                }
                
                tickerKeys.forEach(key => {
                    const ticker = key.replace('ticker_', '');
                    const data = allData[key];
                    
                    output.innerHTML += `<div class="field-analysis">
                        <h4>$${ticker}</h4>
                        <div class="storage-data">${JSON.stringify(data, null, 2)}</div>
                    </div>`;
                    
                    // Analyze fintel fields
                    const fintelFields = [
                        'shortInterest', 'shortInterestRatio', 'shortInterestPercentFloat',
                        'costToBorrow', 'shortSharesAvailable', 'finraExemptVolume', 
                        'failureToDeliver', 'lastDataUpdate'
                    ];
                    
                    let fintelFieldsFound = [];
                    let fintelFieldsMissing = [];
                    
                    fintelFields.forEach(field => {
                        if (data[field] && data[field] !== 'n/a') {
                            fintelFieldsFound.push(`${field}: "${data[field]}"`);
                        } else {
                            fintelFieldsMissing.push(field);
                        }
                    });
                    
                    if (fintelFieldsFound.length > 0) {
                        output.innerHTML += `<div class="success">✅ Fintel fields found: ${fintelFieldsFound.join(', ')}</div>`;
                    }
                    
                    if (fintelFieldsMissing.length > 0) {
                        output.innerHTML += `<div class="error">❌ Fintel fields missing: ${fintelFieldsMissing.join(', ')}</div>`;
                    }
                });
                
            } catch (error) {
                output.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function testSpecificTicker() {
            const output = document.getElementById('storage-output');
            try {
                const result = await chrome.storage.local.get('ticker_OPAD');
                const data = result['ticker_OPAD'];
                
                if (!data) {
                    output.innerHTML += '<div class="error">No data found for OPAD</div>';
                    return;
                }
                
                output.innerHTML += `<div class="field-analysis">
                    <h4>OPAD Storage Data:</h4>
                    <div class="storage-data">${JSON.stringify(data, null, 2)}</div>
                </div>`;
                
                // Test the exact same logic as content.js
                const pack = {
                    shortInterest: data?.shortInterest || 'n/a',
                    shortInterestRatio: data?.shortInterestRatio || 'n/a',
                    shortInterestPercentFloat: data?.shortInterestPercentFloat || 'n/a',
                    costToBorrow: data?.costToBorrow || 'n/a',
                    shortSharesAvailable: data?.shortSharesAvailable || 'n/a',
                    finraExemptVolume: data?.finraExemptVolume || 'n/a',
                    failureToDeliver: data?.failureToDeliver || 'n/a',
                    lastDataUpdate: data?.lastDataUpdate || 'n/a'
                };
                
                output.innerHTML += `<div class="test-data">
                    <h4>Tooltip Pack (what content.js would generate):</h4>
                    <div class="storage-data">${JSON.stringify(pack, null, 2)}</div>
                </div>`;
                
            } catch (error) {
                output.innerHTML += `<div class="error">Error testing OPAD: ${error.message}</div>`;
            }
        }

        async function injectTestData() {
            try {
                const testData = {
                    shortInterest: '12.34%',
                    shortInterestRatio: '2.5 days',
                    shortInterestPercentFloat: '15.67%',
                    costToBorrow: '8.25%',
                    shortSharesAvailable: '150,000',
                    finraExemptVolume: '1.2M',
                    failureToDeliver: '50,000',
                    lastDataUpdate: '2024-03-15 16:00:00 EST',
                    latestFloat: 25.5,
                    lastUpdated: Date.now(),
                    source: 'fintel.io'
                };
                
                await chrome.storage.local.set({
                    'ticker_OPAD': testData
                });
                
                document.getElementById('storage-output').innerHTML += 
                    '<div class="success">✅ Test data injected for OPAD</div>';
                    
            } catch (error) {
                document.getElementById('storage-output').innerHTML += 
                    `<div class="error">Error injecting test data: ${error.message}</div>`;
            }
        }

        async function testDataFlow() {
            const output = document.getElementById('dataflow-output');
            output.innerHTML = '<h3>Testing Data Flow...</h3>';
            
            try {
                // Step 1: Check storage
                const result = await chrome.storage.local.get('ticker_OPAD');
                const storedData = result['ticker_OPAD'];
                
                if (!storedData) {
                    output.innerHTML += '<div class="error">❌ No stored data for OPAD</div>';
                    return;
                }
                
                output.innerHTML += '<div class="success">✅ Found stored data for OPAD</div>';
                
                // Step 2: Simulate fetchPack logic
                const pack = {
                    fetchedAt: storedData?.lastUpdated || Date.now(),
                    float: storedData?.latestFloat ? `${storedData.latestFloat}m shares` : 'n/a',
                    shortInterest: storedData?.shortInterest || 'n/a',
                    shortInterestRatio: storedData?.shortInterestRatio || 'n/a',
                    shortInterestPercentFloat: storedData?.shortInterestPercentFloat || 'n/a',
                    costToBorrow: storedData?.costToBorrow || 'n/a',
                    shortSharesAvailable: storedData?.shortSharesAvailable || 'n/a',
                    finraExemptVolume: storedData?.finraExemptVolume || 'n/a',
                    failureToDeliver: storedData?.failureToDeliver || 'n/a',
                    lastDataUpdate: storedData?.lastDataUpdate || 'n/a'
                };
                
                output.innerHTML += `<div class="field-analysis">
                    <h4>Simulated Pack Object:</h4>
                    <div class="storage-data">${JSON.stringify(pack, null, 2)}</div>
                </div>`;
                
                // Step 3: Check for n/a values
                const nAValues = Object.entries(pack).filter(([key, value]) => value === 'n/a');
                if (nAValues.length > 0) {
                    output.innerHTML += `<div class="error">❌ Fields showing as n/a: ${nAValues.map(([key]) => key).join(', ')}</div>`;
                    
                    // Debug why they're n/a
                    nAValues.forEach(([key]) => {
                        const rawValue = storedData?.[key];
                        output.innerHTML += `<div class="test-data">
                            Debug ${key}: storedData.${key} = "${rawValue}" (type: ${typeof rawValue}, truthy: ${!!rawValue})
                        </div>`;
                    });
                } else {
                    output.innerHTML += '<div class="success">✅ All fields have values</div>';
                }
                
            } catch (error) {
                output.innerHTML += `<div class="error">Error in data flow test: ${error.message}</div>`;
            }
        }

        function clearAll() {
            document.getElementById('storage-output').innerHTML = '';
            document.getElementById('dataflow-output').innerHTML = '';
        }

        // Auto-run inspection on load
        window.addEventListener('load', () => {
            setTimeout(inspectStorage, 500);
        });
    </script>
</body>
</html>