<!DOCTYPE html>
<html>
<head>
    <title>Debug DilutionTracker Complete Flow</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .debug-section { margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 5px; border-left: 4px solid #2196f3; }
        .issue { background: #ffebee; border-left: 4px solid #f44336; padding: 15px; margin: 15px 0; }
        .success { background: #e8f5e8; border-left: 4px solid #4caf50; padding: 15px; margin: 15px 0; }
        .code { background: #1e1e1e; color: #fff; padding: 15px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; overflow-x: auto; }
        .step { margin: 10px 0; padding: 10px; background: white; border-radius: 3px; border-left: 3px solid #ccc; }
        .step.active { border-left-color: #2196f3; }
        .step.success { border-left-color: #4caf50; }
        .step.error { border-left-color: #f44336; }
        button { background: #2196f3; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #1976d2; }
        .highlight { background: #ffeb3b; padding: 2px 4px; }
    </style>
</head>
<body>
    <h1>üêõ Debug DilutionTracker Complete Flow</h1>
    
    <div class="issue">
        <h3>‚ùå Current Problem</h3>
        <p><strong>Symptom:</strong> No color highlighting appearing on DilutionTracker pages</p>
        <p><strong>Expected:</strong> Green highlighting on matching data fields</p>
        <p><strong>Root Cause:</strong> Unknown - need to debug the complete flow</p>
    </div>

    <div class="debug-section">
        <h3>üîç Complete Flow Debugging</h3>
        <p>This will test each step of the DilutionTracker flow:</p>
        <ol>
            <li><span class="highlight">URL Detection</span> - Does the content script detect the URL?</li>
            <li><span class="highlight">Data Extraction</span> - Does it find and parse the data?</li>
            <li><span class="highlight">Highlighting</span> - Does it call the highlighting functions?</li>
            <li><span class="highlight">DOM Updates</span> - Does it actually change the page colors?</li>
        </ol>
        <button onclick="debugCompleteFlow()">üß™ Debug Complete Flow</button>
        <div id="flow-results"></div>
    </div>

    <div class="debug-section">
        <h3>üîß Console Commands to Run</h3>
        <p>When visiting a DilutionTracker page, open the console and run these commands:</p>
        
        <h4>Step 1: Check if content script loaded</h4>
        <div class="code">console.log('QSE loaded:', window.qseDilutionTrackerLoaded);
console.log('Current ticker:', window.qseCurrentTicker);</div>

        <h4>Step 2: Check URL detection</h4>
        <div class="code">const url = window.location.href;
const pattern = /\/app\/search\/([A-Z]{1,5})(?:[/?#]|$)/i;
const match = url.match(pattern);
console.log('URL:', url);
console.log('Pattern match:', match);
console.log('Detected ticker:', match ? match[1] : 'NONE');</div>

        <h4>Step 3: Check for float wrapper element</h4>
        <div class="code">const floatWrapper = document.getElementById('company-description-float-wrapper');
console.log('Float wrapper found:', !!floatWrapper);
if (floatWrapper) {
    console.log('Float wrapper text:', floatWrapper.textContent);
    const loginLink = floatWrapper.querySelector('a[href*="login"]');
    console.log('Login link found (user not logged in):', !!loginLink);
}</div>

        <h4>Step 4: Manually trigger data extraction</h4>
        <div class="code">// If you see a ticker in Step 2, use it here
const ticker = 'OPAD'; // Replace with detected ticker
if (window.extractTickerData) {
    console.log('Manually triggering extraction for:', ticker);
    window.extractTickerData(ticker);
} else {
    console.log('extractTickerData function not found');
}</div>
    </div>

    <div class="debug-section">
        <h3>üö® Common Issues and Fixes</h3>
        
        <div class="step">
            <strong>Issue 1:</strong> Content script not loading
            <br><strong>Fix:</strong> Check manifest.json has correct URL patterns
        </div>
        
        <div class="step">
            <strong>Issue 2:</strong> URL not matching
            <br><strong>Fix:</strong> The regex pattern might need adjustment
        </div>
        
        <div class="step">
            <strong>Issue 3:</strong> Float wrapper not found
            <br><strong>Fix:</strong> DilutionTracker changed their DOM structure
        </div>
        
        <div class="step">
            <strong>Issue 4:</strong> User not logged in
            <br><strong>Fix:</strong> Login to DilutionTracker first
        </div>
        
        <div class="step">
            <strong>Issue 5:</strong> Data parsing fails
            <br><strong>Fix:</strong> The parseFloatData function needs updating
        </div>
        
        <div class="step">
            <strong>Issue 6:</strong> Highlighting functions don't run
            <br><strong>Fix:</strong> Data extraction returned null
        </div>
    </div>

    <div class="debug-section">
        <h3>üìã Manual Testing Checklist</h3>
        <div id="manual-checklist">
            <div class="step">
                <input type="checkbox" id="check1"> 
                <label for="check1">Navigate to https://dilutiontracker.com/app/search/OPAD</label>
            </div>
            <div class="step">
                <input type="checkbox" id="check2"> 
                <label for="check2">Open browser console (F12)</label>
            </div>
            <div class="step">
                <input type="checkbox" id="check3"> 
                <label for="check3">Look for: "üîç DilutionTracker content script loaded"</label>
            </div>
            <div class="step">
                <input type="checkbox" id="check4"> 
                <label for="check4">Look for: "üìä Detected ticker page: OPAD"</label>
            </div>
            <div class="step">
                <input type="checkbox" id="check5"> 
                <label for="check5">Look for: "üîç Extracting data for OPAD..."</label>
            </div>
            <div class="step">
                <input type="checkbox" id="check6"> 
                <label for="check6">Look for: "‚úÖ Found float wrapper"</label>
            </div>
            <div class="step">
                <input type="checkbox" id="check7"> 
                <label for="check7">Look for: "üìä Parsed data:" with actual values</label>
            </div>
            <div class="step">
                <input type="checkbox" id="check8"> 
                <label for="check8">Look for: "‚úÖ Verification icons added"</label>
            </div>
            <div class="step">
                <input type="checkbox" id="check9"> 
                <label for="check9">Check if any text on page turned green</label>
            </div>
        </div>
        <br>
        <button onclick="checkProgress()">üìä Check Progress</button>
        <div id="progress-result"></div>
    </div>

    <script>
        function debugCompleteFlow() {
            const resultsDiv = document.getElementById('flow-results');
            resultsDiv.innerHTML = '<h4>üß™ Flow Debug Results</h4>';

            // Simulate the complete flow step by step
            const steps = [
                {
                    name: 'URL Detection',
                    test: () => {
                        const testUrl = 'https://dilutiontracker.com/app/search/OPAD?a=';
                        const pattern = /\/app\/search\/([A-Z]{1,5})(?:[/?#]|$)/i;
                        const match = testUrl.match(pattern);
                        return {
                            success: !!match,
                            result: match ? match[1] : 'No match',
                            message: match ? `‚úÖ Ticker detected: ${match[1]}` : '‚ùå URL pattern not matching'
                        };
                    }
                },
                {
                    name: 'Content Script Check',
                    test: () => {
                        // Check if we have the function signatures that should exist
                        const hasExtractFunction = typeof window.extractTickerData !== 'undefined';
                        const hasVerificationFunction = typeof window.addVerificationIcons !== 'undefined';
                        return {
                            success: hasExtractFunction,
                            result: `extractTickerData: ${hasExtractFunction}, addVerificationIcons: ${hasVerificationFunction}`,
                            message: hasExtractFunction ? '‚úÖ Content script functions available' : '‚ùå Content script not loaded properly'
                        };
                    }
                },
                {
                    name: 'DOM Element Check',
                    test: () => {
                        // This would normally check for the float wrapper, but we're not on DT page
                        return {
                            success: false,
                            result: 'Cannot test - not on DilutionTracker page',
                            message: '‚ö†Ô∏è Need to test on actual DilutionTracker page'
                        };
                    }
                },
                {
                    name: 'Pattern Variations',
                    test: () => {
                        const pattern = /\/app\/search\/([A-Z]{1,5})(?:[/?#]|$)/i;
                        const testUrls = [
                            'https://dilutiontracker.com/app/search/OPAD',
                            'https://dilutiontracker.com/app/search/OPAD?a=',
                            'https://dilutiontracker.com/app/search/TSLA?a=123',
                            'https://dilutiontracker.com/app/search/AMC/',
                        ];
                        
                        const results = testUrls.map(url => {
                            const match = url.match(pattern);
                            return { url, ticker: match ? match[1] : null };
                        });
                        
                        const successCount = results.filter(r => r.ticker).length;
                        
                        return {
                            success: successCount === testUrls.length,
                            result: results,
                            message: `‚úÖ ${successCount}/${testUrls.length} URL patterns working`
                        };
                    }
                }
            ];

            steps.forEach((step, index) => {
                setTimeout(() => {
                    const stepDiv = document.createElement('div');
                    stepDiv.className = 'step active';
                    stepDiv.innerHTML = `<strong>Step ${index + 1}: ${step.name}</strong><br>Testing...`;
                    resultsDiv.appendChild(stepDiv);

                    setTimeout(() => {
                        const result = step.test();
                        stepDiv.className = `step ${result.success ? 'success' : 'error'}`;
                        stepDiv.innerHTML = `
                            <strong>Step ${index + 1}: ${step.name}</strong><br>
                            ${result.message}<br>
                            <small>Result: ${JSON.stringify(result.result)}</small>
                        `;
                    }, 200);
                }, index * 300);
            });
        }

        function checkProgress() {
            const checkboxes = document.querySelectorAll('#manual-checklist input[type="checkbox"]');
            const checked = Array.from(checkboxes).filter(cb => cb.checked).length;
            const total = checkboxes.length;
            
            const resultDiv = document.getElementById('progress-result');
            resultDiv.innerHTML = `
                <div style="margin-top: 15px; padding: 15px; background: ${checked === total ? '#e8f5e8' : '#fff3e0'}; border-radius: 5px;">
                    <strong>Progress: ${checked}/${total} steps completed</strong><br>
                    ${checked === total ? 
                        'üéâ All steps completed! If colors still not working, the issue is in the data parsing or highlighting logic.' : 
                        `üìù Complete remaining ${total - checked} steps to identify where the issue occurs.`
                    }
                </div>
            `;
        }

        // Auto-run flow debug
        window.addEventListener('load', () => {
            setTimeout(debugCompleteFlow, 500);
        });
    </script>
</body>
</html>