<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Checkmark Icons</title>
    <link rel="stylesheet" href="css/tooltip.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-section h2 {
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .data-item {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            font-size: 16px;
        }
        .data-item:last-child {
            border-bottom: none;
        }
        .simulated-dilution-tracker {
            background-color: #1a1a1a;
            color: white;
            padding: 20px;
            border-radius: 8px;
        }
        .simulated-fintel {
            background-color: #2c3e50;
            color: white;
            padding: 20px;
            border-radius: 8px;
        }
        .float-wrapper {
            background-color: #34495e;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }
        th {
            background-color: rgba(255,255,255,0.1);
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Data Verification Test Page</h1>
    <p>This page tests the green color highlighting functionality for verified data values.</p>

    <!-- Simulated DilutionTracker Content -->
    <div class="test-section simulated-dilution-tracker">
        <h2>Simulated DilutionTracker Data</h2>
        <div id="company-description-float-wrapper" class="float-wrapper">
            <div class="data-item">Float: 12.5M</div>
            <div class="data-item">Outstanding Shares: 25.0M</div>
            <div class="data-item">Sector: Technology</div>
            <div class="data-item">Industry: Software</div>
            <div class="data-item">Country: United States</div>
            <div class="data-item">Market Cap: 500M</div>
        </div>
        <div class="data-item">Estimated current cash of $22.9M</div>
        
        <!-- Test different formats for Sector and Industry -->
        <div class="data-item">Sector: Technology</div>
        <div class="data-item">Industry: Software</div>
        <div class="data-item">Sector Technology Industry Software Country United States</div>
        <div class="data-item">Technology | Software | United States | NASDAQ</div>
    </div>

    <!-- Simulated Fintel Content -->
    <div class="test-section simulated-fintel">
        <h2>Simulated Fintel Data</h2>
        <div class="data-item">Short Interest: 15.2%</div>
        <div class="data-item">Short Interest Ratio: 3.5 days</div>
        <div class="data-item">Short Interest % Float: 18.7%</div>
        <div class="data-item">Cost to Borrow: 12.5%</div>
        <div class="data-item">Fails to Deliver: 125K</div>
        <div class="data-item">FINRA Exempt Volume: 2.5M</div>
        
        <table id="short-shares-availability-table">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Shares Available</th>
                    <th>Fee Rate</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>2024-01-15</td>
                    <td>100K</td>
                    <td>15.2%</td>
                </tr>
                <tr>
                    <td>2024-01-14</td>
                    <td>85K</td>
                    <td>14.8%</td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="test-section">
        <h2>Test Controls</h2>
        <button onclick="simulateFirstTimeData()">Simulate First Time Data (Show All Green Values)</button>
        <button onclick="simulateMatchingData()">Simulate Matching Data (Some Green Values)</button>
        <button onclick="simulateMismatchData()">Simulate Mismatched Data (No Green Values)</button>
        <button onclick="clearCheckmarks()">Clear All Green Styling</button>
        <button onclick="testSectorIndustryDebug()">Test Sector/Industry Debug</button>
    </div>

    <script>
        // Simulate Chrome extension storage API for testing
        window.chrome = {
            storage: {
                local: {
                    data: {},
                    get: function(key) {
                        return Promise.resolve({
                            [key]: this.data[key] || null
                        });
                    },
                    set: function(obj) {
                        Object.assign(this.data, obj);
                        return Promise.resolve();
                    }
                }
            }
        };

        // Load the CSS for icons
        const link = document.createElement('link');
        link.rel = 'stylesheet';
        link.href = 'css/tooltip.css';
        document.head.appendChild(link);
        
        // Load the actual dilutiontracker content script for testing
        const script = document.createElement('script');
        script.src = 'dilutiontracker_content.js';
        document.head.appendChild(script);

        function addIndividualCheckmarks(matchingFields, isFirstTime) {
            console.log(`ðŸ” Adding individual checkmarks for fields:`, matchingFields);
            
            matchingFields.forEach(({ field, value, label }) => {
                const container = findContainerForValue(field, label, value);
                if (container) {
                    addCheckmarkToContainer(container, field, label, value, isFirstTime);
                } else {
                    console.log(`âŒ Could not find container for ${field}: ${label}`);
                }
            });
            
            console.log(`âœ… Added individual checkmarks for ${matchingFields.length} fields`);
        }

        function findContainerForValue(field, label, value) {
            // Define search patterns for different field types
            const searchPatterns = {
                float: [
                    /float[:\s]+([0-9,.]+)\s*([MB])/i,
                    /([0-9,.]+)\s*([MB])\s+float/i
                ],
                outstanding: [
                    /(?:shares?\s*outstanding|outstanding\s*shares?|os)[:\s]+([0-9,.]+)\s*([MB])/i,
                    /([0-9,.]+)\s*([MB])\s+(?:shares?\s*outstanding|outstanding\s*shares?|os)/i
                ],
                estimatedCash: [
                    /(?:estimated\s+)?(?:current\s+)?cash\s+of\s+\$([0-9,.]+)\s*([MB])/i,
                    /cash[:\s]+\$([0-9,.]+)\s*([MB])/i
                ],
                sector: [
                    /sector[:\s]+([^|\n\r]+)/i
                ],
                industry: [
                    /industry[:\s]+([^|\n\r]+)/i
                ],
                country: [
                    /country[:\s]+([^|\n\r]+)/i
                ],
                marketCap: [
                    /(?:market cap|mkt cap)[:\s]+([0-9,.]+[KMB])/i
                ]
            };
            
            const patterns = searchPatterns[field];
            if (!patterns) {
                console.log(`âŒ No search patterns defined for field: ${field}`);
                return null;
            }
            
            // Search through all data items for the pattern
            const dataItems = document.querySelectorAll('.data-item');
            for (const item of dataItems) {
                const text = item.textContent;
                
                for (const pattern of patterns) {
                    if (pattern.test(text)) {
                        console.log(`âœ… Found container for ${field} (${label}): ${item.tagName} with text: "${text.trim()}"`);
                        return item;
                    }
                }
            }
            
            console.log(`âŒ Could not find container for ${field} with patterns:`, patterns);
            return null;
        }

        function addCheckmarkToContainer(container, field, label, value, isFirstTime) {
            // Check if green styling already applied to this container
            if (container.style.color === 'rgb(34, 197, 94)') {
                console.log(`âš ï¸ Green styling already applied to container for ${field}`);
                return;
            }
            
            // Apply green color styling to the container
            container.style.color = 'rgb(34, 197, 94)';
            container.style.fontWeight = '500'; // Slightly bolder for emphasis
            container.title = isFirstTime ? 
                `First time extracting ${label}: ${value}` : 
                `${label} matches extension storage: ${value}`;
            
            // Add a subtle class for identification
            container.classList.add('qse-verified-value');
            
            console.log(`âœ… Applied green styling to container for ${field} (${label}): ${value}`);
        }

        function simulateFirstTimeData() {
            console.log('ðŸ”§ Simulating first time data - showing all checkmarks');
            clearCheckmarks();
            
            const matchingFields = [
                { field: 'float', value: '12.5M', label: 'Float' },
                { field: 'outstanding', value: '25.0M', label: 'Shares Outstanding' },
                { field: 'sector', value: 'Technology', label: 'Sector' },
                { field: 'industry', value: 'Software', label: 'Industry' },
                { field: 'country', value: 'United States', label: 'Country' },
                { field: 'marketCap', value: '500M', label: 'Market Cap' }
            ];
            addIndividualCheckmarks(matchingFields, true);
        }

        function simulateMatchingData() {
            console.log('ðŸ”§ Simulating matching data - showing checkmarks for matching values');
            clearCheckmarks();
            
            // Simulate that only some fields match
            const matchingFields = [
                { field: 'float', value: '12.5M', label: 'Float' },
                { field: 'sector', value: 'Technology', label: 'Sector' },
                { field: 'marketCap', value: '500M', label: 'Market Cap' }
            ];
            addIndividualCheckmarks(matchingFields, false);
        }

        function simulateMismatchData() {
            console.log('ðŸ”§ Simulating mismatched data - no checkmarks shown');
            clearCheckmarks();
        }

        function clearCheckmarks() {
            // Remove green styling from all verified values
            document.querySelectorAll('.qse-verified-value').forEach(element => {
                element.style.color = '';
                element.style.fontWeight = '';
                element.title = '';
                element.classList.remove('qse-verified-value');
            });
            
            // Also clear any remaining old checkmark icons
            document.querySelectorAll('.qse-verified-icon').forEach(icon => {
                icon.remove();
            });
            
            console.log('ðŸ§¹ Cleared all green styling and checkmarks');
        }

        function testSectorIndustryDebug() {
            console.log('ðŸ§ª Testing Sector and Industry extraction and highlighting');
            clearCheckmarks();
            
            // Test specific sector and industry values
            const testFields = [
                { field: 'sector', value: 'Technology', label: 'Sector' },
                { field: 'industry', value: 'Software', label: 'Industry' }
            ];
            
            testFields.forEach(({ field, value, label }) => {
                console.log(`ðŸ§ª Testing ${field} with value "${value}"`);
                const container = findContainerForValue(field, label, value);
                if (container) {
                    addCheckmarkToContainer(container, field, label, value, false);
                }
            });
        }

        // Show initial state (first time)
        setTimeout(() => {
            simulateFirstTimeData();
        }, 1000);
    </script>
</body>
</html>