<!DOCTYPE html>
<html>
<head>
    <title>Debug Sector & Industry Highlighting Issue</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .debug-section { margin: 20px 0; padding: 15px; background: #f5f5f5; border-radius: 5px; border-left: 4px solid #2196f3; }
        .issue { background: #ffebee; border-left: 4px solid #f44336; padding: 15px; margin: 15px 0; }
        .success { background: #e8f5e8; border-left: 4px solid #4caf50; padding: 15px; margin: 15px 0; }
        .code { background: #1e1e1e; color: #fff; padding: 15px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; }
        button { background: #2196f3; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #1976d2; }
        .highlight { background: #ffeb3b; padding: 2px 4px; }
    </style>
</head>
<body>
    <h1>üêõ Debug Sector & Industry Highlighting Issue</h1>
    
    <div class="issue">
        <h3>‚ùå Current Problem</h3>
        <p><strong>Issue:</strong> "Sector:" and "Industry:" fields not highlighting on DilutionTracker</p>
        <p><strong>Other fields work:</strong> Float, Outstanding, etc. are highlighting correctly</p>
        <p><strong>Root cause:</strong> Need to debug why these two specific fields fail</p>
    </div>

    <div class="debug-section">
        <h3>üîç Debug Commands for DilutionTracker Console</h3>
        <p>When on a DilutionTracker page, open console and run these commands:</p>
        
        <h4>1. Check if data is being extracted</h4>
        <div class="code">// Check if sector/industry data was extracted
const ticker = window.qseCurrentTicker;
if (ticker) {
    console.log('Current ticker:', ticker);
    // Try to access stored data
    chrome.storage.local.get([ticker], function(result) {
        const data = result[ticker];
        console.log('Stored data for', ticker + ':', data);
        console.log('Sector:', data?.sector || 'NOT FOUND');
        console.log('Industry:', data?.industry || 'NOT FOUND');
    });
}</div>

        <h4>2. Test the highlightLabelSibling function directly</h4>
        <div class="code">// Manually test highlighting with dummy data
window.qseDebug.highlightLabelSibling('Sector:', 'Technology');
window.qseDebug.highlightLabelSibling('Industry:', 'Software');

// Check what text nodes contain these labels
const walker = document.createTreeWalker(
    document.body,
    NodeFilter.SHOW_TEXT,
    null,
    false
);

let sectorFound = false, industryFound = false;
let node;
while (node = walker.nextNode()) {
    const text = node.nodeValue.trim();
    if (text.includes('Sector:')) {
        console.log('Found "Sector:" in:', text);
        console.log('Parent element:', node.parentElement);
        sectorFound = true;
    }
    if (text.includes('Industry:')) {
        console.log('Found "Industry:" in:', text);
        console.log('Parent element:', node.parentElement);
        industryFound = true;
    }
}

console.log('Sector label found:', sectorFound);
console.log('Industry label found:', industryFound);</div>

        <h4>3. Check DOM structure around Sector/Industry</h4>
        <div class="code">// Find all elements containing sector or industry text
const allElements = document.querySelectorAll('*');
const sectorElements = [];
const industryElements = [];

Array.from(allElements).forEach(el => {
    const text = el.textContent.toLowerCase();
    if (text.includes('sector') && text.length < 200) {
        sectorElements.push({
            element: el,
            text: el.textContent.trim(),
            tagName: el.tagName
        });
    }
    if (text.includes('industry') && text.length < 200) {
        industryElements.push({
            element: el,
            text: el.textContent.trim(),
            tagName: el.tagName
        });
    }
});

console.log('Elements containing "sector":', sectorElements);
console.log('Elements containing "industry":', industryElements);</div>

        <h4>4. Test pattern matching on actual page content</h4>
        <div class="code">// Get all text content and test sector/industry patterns
const textNodes = [];
const walker = document.createTreeWalker(
    document.body,
    NodeFilter.SHOW_TEXT,
    null,
    false
);

let node;
while (node = walker.nextNode()) {
    if (node.nodeValue.trim()) {
        textNodes.push(node.nodeValue.trim());
    }
}

const fullText = textNodes.join(' ');
console.log('Full page text sample:', fullText.substring(0, 1000));

// Test sector patterns
const sectorPatterns = [
    /\bSector:\s*([^\n\r]*?)(?=\s*Industry:|\s*Country:|\s*Exchange:|\s*$)/i,
    /\bSector[:\s]+([^|\n\r]+?)(?=\s+Industry|\s+Country|\s+Exchange|$)/i,
    /sector[:\s]*([^|\n\r,;]+)/i
];

console.log('Testing sector patterns:');
sectorPatterns.forEach((pattern, i) => {
    const match = fullText.match(pattern);
    console.log(`Pattern ${i + 1}: ${pattern} -> ${match ? `Match: "${match[1]}"` : 'No match'}`);
});

// Test industry patterns  
const industryPatterns = [
    /\bIndustry:\s*([^\n\r]*?)(?=\s*Country:|\s*Exchange:|\s*Sector:|\s*$)/i,
    /\bIndustry[:\s]+([^|\n\r]+?)(?=\s+Country|\s+Exchange|\s+Sector|$)/i,
    /industry[:\s]*([^|\n\r,;]+)/i
];

console.log('Testing industry patterns:');
industryPatterns.forEach((pattern, i) => {
    const match = fullText.match(pattern);
    console.log(`Pattern ${i + 1}: ${pattern} -> ${match ? `Match: "${match[1]}"` : 'No match'}`);
});</div>
    </div>

    <div class="debug-section">
        <h3>üéØ Most Likely Issues</h3>
        <ol>
            <li><strong>Data not extracted:</strong> The sector/industry regex patterns aren't matching the page content</li>
            <li><strong>Labels not found:</strong> The DOM structure changed and "Sector:" / "Industry:" text isn't where expected</li>
            <li><strong>Highlighting logic issue:</strong> The highlightLabelSibling function isn't finding the right elements</li>
            <li><strong>Value mismatch:</strong> The extracted values don't match what's on the page for verification</li>
        </ol>
    </div>

    <div class="debug-section">
        <h3>üîß Quick Test</h3>
        <p>If you're on this debug page but want to test the logic:</p>
        <button onclick="simulateTest()">üß™ Simulate Sector/Industry Test</button>
        <div id="test-results"></div>
    </div>

    <script>
        function simulateTest() {
            const resultsDiv = document.getElementById('test-results');
            
            // Simulate what would happen on a real DilutionTracker page
            const mockData = {
                sector: 'Technology',
                industry: 'Software - Application'
            };
            
            console.log('üß™ Simulating sector/industry highlighting test...');
            console.log('Mock extracted data:', mockData);
            
            // Create sample DOM structure similar to DilutionTracker
            const testContainer = document.createElement('div');
            testContainer.innerHTML = `
                <div>Sector: Technology</div>
                <div>Industry: Software - Application</div>
                <div>Country: United States</div>
            `;
            document.body.appendChild(testContainer);
            
            // Test the highlighting logic (simplified version)
            function testHighlightLabelSibling(labelText, expectedValue) {
                console.log(`üéØ Testing label "${labelText}" with value "${expectedValue}"`);
                
                const walker = document.createTreeWalker(
                    document.body,
                    NodeFilter.SHOW_TEXT,
                    null,
                    false
                );
                
                let found = false;
                let node;
                while (node = walker.nextNode()) {
                    const text = node.nodeValue.trim();
                    if (text.includes(labelText)) {
                        console.log(`‚úÖ Found label "${labelText}" in text: "${text}"`);
                        
                        const parentText = node.parentElement.textContent;
                        if (parentText.includes(expectedValue)) {
                            console.log(`‚úÖ Found matching value "${expectedValue}" in parent: "${parentText}"`);
                            node.parentElement.style.color = 'rgb(34, 197, 94)';
                            node.parentElement.style.fontWeight = '500';
                            found = true;
                            break;
                        }
                    }
                }
                
                return found;
            }
            
            // Test both labels
            const sectorResult = testHighlightLabelSibling('Sector:', mockData.sector);
            const industryResult = testHighlightLabelSibling('Industry:', mockData.industry);
            
            resultsDiv.innerHTML = `
                <div style="margin-top: 15px; padding: 15px; background: #f9f9f9; border-radius: 5px;">
                    <h4>üß™ Simulation Results:</h4>
                    <p><strong>Sector highlighting:</strong> ${sectorResult ? '‚úÖ Success' : '‚ùå Failed'}</p>
                    <p><strong>Industry highlighting:</strong> ${industryResult ? '‚úÖ Success' : '‚ùå Failed'}</p>
                    <p><em>Look above for sample highlighted text if successful</em></p>
                </div>
            `;
            
            // Clean up test elements after 5 seconds
            setTimeout(() => {
                testContainer.remove();
            }, 5000);
        }
        
        // Instructions for actual debugging
        console.log(`
üêõ SECTOR & INDUSTRY DEBUG INSTRUCTIONS:

1. Go to a DilutionTracker page like: https://dilutiontracker.com/app/search/OPAD
2. Open console (F12)
3. Copy and paste the debug commands from this page
4. Look for these key messages:
   - "Found sector: [value]" or "Found industry: [value]"
   - "Found label 'Sector:' in text: ..." 
   - "Verified value match for 'Sector:': ..."
   
5. If no sector/industry data is extracted, the regex patterns need updating
6. If data is extracted but highlighting fails, the DOM structure analysis is needed
        `);
    </script>
</body>
</html>